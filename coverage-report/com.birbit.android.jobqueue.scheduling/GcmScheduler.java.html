<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GcmScheduler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jobqueue</a> &gt; <a href="index.source.html" class="el_package">com.birbit.android.jobqueue.scheduling</a> &gt; <span class="el_source">GcmScheduler.java</span></div><h1>GcmScheduler.java</h1><pre class="source lang-java linenums">package com.birbit.android.jobqueue.scheduling;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.SharedPreferences;
import android.os.Bundle;

import com.birbit.android.jobqueue.BatchingScheduler;
import com.birbit.android.jobqueue.log.JqLog;
import com.birbit.android.jobqueue.network.NetworkUtil;
import com.google.android.gms.gcm.GcmNetworkManager;
import com.google.android.gms.gcm.OneoffTask;
import com.google.android.gms.gcm.Task;
import com.google.android.gms.gcm.TaskParams;

import java.util.UUID;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

class GcmScheduler extends Scheduler {
    private static final String KEY_UUID = &quot;uuid&quot;;
    private static final String KEY_ID = &quot;id&quot;;
    private static final String KEY_DELAY = &quot;delay&quot;;
    private static final String KEY_NETWORK_STATUS = &quot;networkStatus&quot;;
    private static SharedPreferences preferences;
    private final GcmNetworkManager gcmNetworkManager;
    private final Class&lt;? extends GcmJobSchedulerService&gt; serviceClass;

<span class="nc" id="L29">    GcmScheduler(Context context, Class&lt;? extends GcmJobSchedulerService&gt; serviceClass) {</span>
<span class="nc" id="L30">        this.serviceClass = serviceClass;</span>
<span class="nc" id="L31">        gcmNetworkManager = GcmNetworkManager.getInstance(context.getApplicationContext());</span>
<span class="nc" id="L32">    }</span>

    private static SharedPreferences getPreferences(Context context) {
<span class="nc" id="L35">        synchronized (GcmScheduler.class) {</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">            if (preferences == null) {</span>
<span class="nc" id="L37">                preferences = context.getSharedPreferences(&quot;jobqueue_gcm_scheduler&quot;,</span>
                        Context.MODE_PRIVATE);
            }
<span class="nc" id="L40">            return preferences;</span>
<span class="nc" id="L41">        }</span>
    }

    /**
     * Creates a new ID for the job info. Can be overridden if you need to provide different ids not
     * to conflict with the rest of your application.
     *
     * @return A unique integer id for the next Job request to be sent to system scheduler
     */
    @SuppressLint(&quot;CommitPrefEdits&quot;)
    private int createId() {
<span class="nc" id="L52">        synchronized (GcmScheduler.class) {</span>
<span class="nc" id="L53">            final SharedPreferences preferences = getPreferences(getApplicationContext());</span>
<span class="nc" id="L54">            final int id = preferences.getInt(KEY_ID, 0) + 1;</span>
<span class="nc" id="L55">            preferences.edit().putInt(KEY_ID, id).commit();</span>
<span class="nc" id="L56">            return id;</span>
<span class="nc" id="L57">        }</span>
    }

    @Override
    public void request(SchedulerConstraint constraint) {
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (JqLog.isDebugEnabled()) {</span>
<span class="nc" id="L63">            JqLog.d(&quot;creating gcm wake up request for %s&quot;, constraint);</span>
        }
<span class="nc bnc" id="L65" title="All 2 branches missed.">        long endTimeMs = constraint.getOverrideDeadlineInMs() == null</span>
<span class="nc" id="L66">                ? constraint.getDelayInMs() + TimeUnit.SECONDS.toMillis(getExecutionWindowSizeInSeconds())</span>
<span class="nc" id="L67">                : constraint.getOverrideDeadlineInMs();</span>
<span class="nc" id="L68">        OneoffTask oneoffTask = new OneoffTask.Builder()</span>
<span class="nc" id="L69">                .setExecutionWindow(TimeUnit.MILLISECONDS.toSeconds(constraint.getDelayInMs()),</span>
<span class="nc" id="L70">                        TimeUnit.MILLISECONDS.toSeconds(endTimeMs))</span>
<span class="nc" id="L71">                .setRequiredNetwork(toNetworkState(constraint.getNetworkStatus()))</span>
<span class="nc" id="L72">                .setPersisted(true)</span>
<span class="nc" id="L73">                .setService(serviceClass)</span>
<span class="nc" id="L74">                .setTag(&quot;jobmanager-&quot; + createId())</span>
<span class="nc" id="L75">                .setExtras(toBundle(constraint))</span>
<span class="nc" id="L76">                .build();</span>
<span class="nc" id="L77">        gcmNetworkManager.schedule(oneoffTask);</span>
<span class="nc" id="L78">    }</span>

    /**
     * GCMNetworkManager accepts an execution window for jobs so that it can batch them together for
     * better battery utilization. You can override this method to provide a different execution
     * window. The default value is {@link BatchingScheduler#DEFAULT_BATCHING_PERIOD_IN_MS} (converted
     * to seconds).
     * &lt;p&gt;
     * If this scheduling request is made for a Job with a deadline, this method is NOT called.
     *
     * @return The execution window time for the Job request
     */
    private long getExecutionWindowSizeInSeconds() {
<span class="nc" id="L91">        return TimeUnit.MILLISECONDS.toSeconds(BatchingScheduler.DEFAULT_BATCHING_PERIOD_IN_MS);</span>
    }

    @Override
    public void cancelAll() {
<span class="nc" id="L96">        gcmNetworkManager.cancelAllTasks(serviceClass);</span>
<span class="nc" id="L97">    }</span>

    private static int toNetworkState(@NetworkUtil.NetworkStatus int networkStatus) {
<span class="nc bnc" id="L100" title="All 4 branches missed.">        switch (networkStatus) {</span>
            case NetworkUtil.DISCONNECTED:
<span class="nc" id="L102">                return Task.NETWORK_STATE_ANY;</span>
            case NetworkUtil.METERED:
<span class="nc" id="L104">                return Task.NETWORK_STATE_CONNECTED;</span>
            case NetworkUtil.UNMETERED:
<span class="nc" id="L106">                return Task.NETWORK_STATE_UNMETERED;</span>
        }
<span class="nc" id="L108">        JqLog.e(&quot;unknown network status %d. Defaulting to CONNECTED&quot;, networkStatus);</span>
<span class="nc" id="L109">        return Task.NETWORK_STATE_CONNECTED;</span>
    }

    private static Bundle toBundle(SchedulerConstraint constraint) {
<span class="nc" id="L113">        Bundle bundle = new Bundle();</span>
        // put boolean is api 22
<span class="nc" id="L115">        bundle.putString(KEY_UUID, constraint.getUuid());</span>
<span class="nc" id="L116">        bundle.putInt(KEY_NETWORK_STATUS, constraint.getNetworkStatus());</span>
<span class="nc" id="L117">        bundle.putLong(KEY_DELAY, constraint.getDelayInMs());</span>
<span class="nc" id="L118">        return bundle;</span>
    }

    private static SchedulerConstraint fromBundle(Bundle bundle) {
<span class="nc" id="L122">        SchedulerConstraint constraint = new SchedulerConstraint(bundle.getString(KEY_UUID));</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (constraint.getUuid() == null) {</span>
            // backward compatibility
<span class="nc" id="L125">            constraint.setUuid(UUID.randomUUID().toString());</span>
        }
<span class="nc" id="L127">        constraint.setNetworkStatus(bundle.getInt(KEY_NETWORK_STATUS, NetworkUtil.DISCONNECTED));</span>
<span class="nc" id="L128">        constraint.setDelayInMs(bundle.getLong(KEY_DELAY, 0));</span>
<span class="nc" id="L129">        return constraint;</span>
    }

    int onStartJob(TaskParams taskParams) {
<span class="nc" id="L133">        SchedulerConstraint constraint = fromBundle(taskParams.getExtras());</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (JqLog.isDebugEnabled()) {</span>
<span class="nc" id="L135">            JqLog.d(&quot;starting job %s&quot;, constraint);</span>
        }

<span class="nc" id="L138">        ResultCallback callback = new ResultCallback();</span>
<span class="nc" id="L139">        constraint.setData(callback);</span>
<span class="nc" id="L140">        start(constraint);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        return callback.get() ? GcmNetworkManager.RESULT_RESCHEDULE : GcmNetworkManager.RESULT_SUCCESS;</span>
    }

    @Override
    public void onFinished(SchedulerConstraint constraint, boolean reschedule) {
<span class="nc" id="L146">        Object data = constraint.getData();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (JqLog.isDebugEnabled()) {</span>
<span class="nc" id="L148">            JqLog.d(&quot;finished job %s&quot;, constraint);</span>
        }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (data instanceof ResultCallback) {</span>
<span class="nc" id="L151">            ResultCallback callback = (ResultCallback) data;</span>
<span class="nc" id="L152">            callback.onDone(reschedule);</span>
        }
<span class="nc" id="L154">    }</span>

    private static class ResultCallback {
        volatile boolean reschedule;
        CountDownLatch latch;

<span class="nc" id="L160">        ResultCallback() {</span>
<span class="nc" id="L161">            latch = new CountDownLatch(1);</span>
<span class="nc" id="L162">            reschedule = false;</span>
<span class="nc" id="L163">        }</span>

        public boolean get() {
            try {
<span class="nc" id="L167">                latch.await(10 * 60, TimeUnit.SECONDS);</span>
<span class="nc" id="L168">            } catch (InterruptedException e) {</span>
<span class="nc" id="L169">                JqLog.e(&quot;job did not finish in 10 minutes :/&quot;);</span>
<span class="nc" id="L170">            }</span>
<span class="nc" id="L171">            return reschedule;</span>
        }

        void onDone(boolean reschedule) {
<span class="nc" id="L175">            this.reschedule = reschedule;</span>
<span class="nc" id="L176">            latch.countDown();</span>
<span class="nc" id="L177">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>